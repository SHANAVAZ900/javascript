<!DOCTYPE html>
<html>

<head>
    <title>Search</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <script>


        function loadDoc() {
            let request = new XMLHttpRequest();
            var res = document.forms['res']['find'].value;
            console.log(res)
            // var url = "http//:127.0.0.1:5000/api/search/" + "?" + "search=" + res
            request.open("POST", "/api/search/");
            request.setRequestHeader("Content-Type", "application/json");
            request.send(JSON.stringify({
                "search": res
            }));
            request.onload = () => {

                if (request.status === 200) {
                    console.log("entered3")
                    var data = JSON.parse(request.responseText)
                    console.log(data)
                    let str = ""
                    lst = []



                    for (let i = 0; i < data["author"].length; i++) {


                        str = str + "<tr>" +
                            "<td>" + "<a href=javascript:bookPage(" + i + ")>" + data["isbn"][i] + "</a>" + "</td>" +
                            "<td>" + data["title"][i] + "</td>" +
                            "<td>" + data["author"][i] + "</td>" +
                            "<td>" + data["year"][i] + "</td>" + "</tr>"
                        lst.push(data["isbn"][i])
                        console.log(str)

                    }
                    document.getElementById("tb").innerHTML = str;

                } else {
                    console.log(`error ${request.status} ${request.statusText}`)
                }

            }
            event.preventDefault()
            return false
        }


        function bookPage(isbn) {
            var usr = document.getElementById("username").innerHTML;
            console.log(usr);
            var isbn = lst[isbn];

            // update global
            username = usr;
            bookisbn = isbn;
            console.log(isbn);

            let request = new XMLHttpRequest();
            request.open("POST", "/api/book/");
            request.setRequestHeader("Content-Type", "application/json");
            request.send(JSON.stringify({ isbn: isbn }));

            //Setting the table display property to None.
            let myElement = document.querySelector(".hide-table");
            myElement.style.display = "none";

            request.onload = () => {
                if (request.status === 200) {
                    var data = JSON.parse(request.responseText);
                    console.log(data);

                    let str = "";

                    str =
                        str +
                        `<table id="tab">
                        <tr>
                        <thead>
                            <h1>${data["title"]}</h1>
                        </thead>
                        </tr>
                        <tr>
                        <td class="isbn"><b>ISBN:&nbsp&nbsp</b>${isbn}</td>
                        <td><b>Author:&nbsp&nbsp</b>${data["author"]}</td>
                        </tr>
                        <tr>
                        <td><b>Rating:&nbsp&nbsp</b>${data["average_rating"]}</td>
                        <td><b>Year Published:&nbsp&nbsp</b>${data["year"]}</td>
                        </tr>
                        <tr>
                        <td><b>Review Count:&nbsp&nbsp</b>${data["average_reviewcount"]}</td>
                        </tr>
                        </table> `;
                    console.log(str)

                    document.querySelector(".clearfix").innerHTML = str;





                }
            };
        }

    </script>

</head>

<body>



    <form class="form-inline my-2 my-lg-0" action="{{ url_for('logout',username=username) }}">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Logout</button>
    </form>
    </div>
    </nav>
    <div class="container">
        <div class="container">
            <div class="d-flex justify-content-center">
                <div class="searchbar">
                    <form name="res">
                        <input class="search_input" type="text" name="find" placeholder="search_input">

                        <button type="submit" class="btn btn-success" onclick="loadDoc()">Search</button>

                        <!--<button type="submit" class="btn btn-success" onclick="loadDoc()"
                            formaction="{{ url_for('search',username=username) }}" formmethod="POST">Search</button>-->
                    </form>
                </div>
            </div>
        </div>
        <h1 id="username" name="userName" style="display: none;">{{user}}</h1>

        <div class="hide-table">
            <h3 style="margin: 20px;">Search Results</h3>
            <table style="text-align: center;" class="table">
                <thead class="thead-dark">
                    <tr id="search">
                        <th scope="col">Book</th>
                        <th scope="col" id="isbn">Isbn</th>
                        <th scope="col">Title</th>
                        <th scope="col">Author</th>
                        <th scope="col">Year</th>
                    </tr>
                </thead>
                <tbody id="tb"></tbody>
            </table>
        </div>
        <div class="clearfix"></div>
        <hr />

    </div>
</body>

</html>